#!/bin/bash

if [ -z "$ERLDUCE_HOME" ]; then
    FILE=`readlink -m "$0"`
    DIR=`dirname "$FILE"`
    ERLDUCE_HOME=`cd "$DIR"; cd ..; pwd;`
fi


if [ -z "$1" ] || [ "$1" == "start" ]; then
    shift
    erl \
        -pa "$ERLDUCE_HOME/ebin" "$ERLDUCE_HOME/deps/"*"/ebin" \
        -rsh ssh \
        -config "$ERLDUCE_HOME/erlduce.config" \
        -sname erlduce \
        -s erlduce \
        $@;
else
    CMD=$1
    shift

    ARGS=`echo -n "$@" | sed 's/"/\\\\"/g'`
    HOST=`hostname`
    NODE="'erlduce@$HOST'"

    erl \
        -noshell \
        -sname "erlduce-cmd-$$" \
        -pa "$ERLDUCE_HOME/ebin" "$ERLDUCE_HOME/deps/"*"/ebin" \
        -config "$ERLDUCE_HOME/erlduce.config" \
        -erlduce master $NODE \
        -eval "
            erlduce_cli:start(),
            erlduce_cli:cmd(\"$CMD\", \"$ARGS\").
        "
fi
